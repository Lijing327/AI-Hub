# 附件记录创建流程说明

## 📋 流程概述

**附件记录是自动创建的，不需要手动上传！**

整个流程如下：

```
Excel 导入
  ↓
Python 服务解析 Excel
  ↓
提取附件引用（如：参考"门限位快速短接"）
  ↓
在文件系统中查找匹配的文件
  ↓
找到文件后，收集附件信息（文件名、URL、大小、类型）
  ↓
调用 .NET 后端批量创建文章 API
  ↓
文章创建成功后，获取 ArticleId
  ↓
调用 .NET 后端批量创建附件 API
  ↓
附件记录写入数据库（kb_asset 表）✅
  ↓
前端查询时自动加载附件
```

## 🔍 验证附件记录是否创建成功

### 方法 1：查看导入日志

导入 Excel 后，查看 Python 服务的日志输出：

```
INFO:__main__:✅ 附件创建结果: 成功 6 个，失败 0 个
INFO:__main__:  ✓ 附件 [0] 已写入数据库: ArticleId=324, FileName=拆下法兰.jpg, AssetId=123
```

如果看到 `已写入数据库` 和 `AssetId`，说明附件记录已经成功创建。

### 方法 2：查询数据库

直接查询数据库确认：

```sql
-- 查看某个文章的附件
SELECT 
    id,
    article_id,
    file_name,
    url,
    asset_type,
    size,
    tenant_id,
    created_at
FROM kb_asset
WHERE article_id = [文章ID]
  AND tenant_id = 'default'
  AND deleted_at IS NULL
ORDER BY created_at DESC;
```

### 方法 3：查看前端

在前端知识详情页面，应该能看到"附件"部分显示所有附件。

## ⚠️ 常见问题

### 问题 1：附件记录没有创建

**可能原因：**
1. 文件没有找到（文件名不匹配）
2. 文章创建失败（ArticleId 无效）
3. 租户ID不匹配
4. API调用失败

**解决方法：**
- 查看 Python 服务日志，确认是否找到文件
- 查看 .NET 后端日志，确认附件创建是否成功
- 检查数据库中的 `kb_asset` 表

### 问题 2：附件记录创建了，但前端不显示

**可能原因：**
1. 租户ID不匹配（查询时过滤掉了）
2. 附件被软删除（deleted_at 不为空）
3. 前端没有正确加载附件

**解决方法：**
- 检查前端请求的租户ID是否与创建时一致
- 检查数据库中的 `deleted_at` 字段
- 查看浏览器控制台是否有错误

### 问题 3：多个引用只创建了一个附件

**可能原因：**
1. 其他引用没有找到匹配的文件
2. 文件匹配逻辑有问题

**解决方法：**
- 查看日志中的 `多引用匹配结果: X/Y 个引用找到文件`
- 检查未找到文件的引用，确认文件名是否正确

## 📊 当前实现状态

✅ **已实现的功能：**
- 自动从 Excel 提取附件引用
- 在文件系统中查找匹配的文件
- 自动创建附件记录到数据库
- 支持一个文章多个附件
- 支持根目录和子文件夹的文件匹配

⚠️ **需要注意：**
- 文件必须在 `ATTACHMENT_BASE_PATH` 配置的目录中
- 文件名或文件夹名需要与 Excel 中的引用匹配
- 租户ID必须一致（创建和查询时）

## 🔧 调试步骤

如果附件记录没有正确创建，按以下步骤排查：

1. **检查文件是否找到**
   ```
   查看日志：INFO:__main__:✓ 找到附件文件: ...
   ```

2. **检查文章是否创建成功**
   ```
   查看日志：INFO:__main__:.NET 后端响应状态码: 200
   查看日志：INFO:__main__:准备创建 X 个附件记录
   ```

3. **检查附件是否创建成功**
   ```
   查看日志：INFO:__main__:✅ 附件创建结果: 成功 X 个
   查看日志：INFO:__main__:  ✓ 附件 [X] 已写入数据库: AssetId=...
   ```

4. **检查数据库**
   ```sql
   SELECT * FROM kb_asset WHERE article_id = [文章ID];
   ```

5. **检查前端查询**
   - 打开浏览器开发者工具
   - 查看网络请求：`GET /api/knowledgeitems/{id}`
   - 检查响应中是否包含 `assets` 字段

## 💡 总结

**附件记录是自动创建的，不需要手动上传！**

如果附件没有显示，请：
1. 查看导入日志，确认附件是否找到和创建
2. 检查数据库，确认记录是否存在
3. 检查租户ID是否一致
4. 查看前端网络请求，确认数据是否正确返回
