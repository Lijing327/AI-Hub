# 维修视频（附件）处理策略

## 当前实现（阶段1：文本引用）

**策略**：将"维修视频（附件）"的文本内容（如"参考"下芯机比例阀拆解"）追加到 `solution_text` 中。

**优点**：
- ✅ RAG 可以检索到文本引用
- ✅ 实现简单，无需文件匹配
- ✅ 保持原文完整性

**缺点**：
- ❌ 无法直接访问实际文件
- ❌ 用户需要手动查找文件

## 推荐方案（阶段2：混合模式）

### 1. 文本引用保留在 solution_text

```python
# 在 solution_text 中保留文本引用
【维修视频（附件）】
参考"下芯机比例阀拆解"
```

**原因**：RAG 检索时，chunk 会包含这个文本，AI 可以知道有相关视频。

### 2. 文件匹配并创建 kb_asset

如果 Excel 中的"维修视频（附件）"列包含文件名或路径，尝试匹配：

```python
# 示例：从文本中提取文件名
video_reference = "参考"下芯机比例阀拆解""
# 提取文件名：下芯机比例阀拆解
# 在固定目录中查找：/static/videos/下芯机比例阀拆解.mp4
# 如果找到，创建 kb_asset 记录
```

### 3. 文件存储结构建议

```
/static/
  ├── videos/          # 视频文件
  │   ├── 下芯机比例阀拆解.mp4
  │   └── 加砂球阀清挤砂.mp4
  ├── images/          # 图片文件
  │   └── ...
  └── documents/       # 文档文件
      └── ...
```

### 4. 匹配规则

1. **文本提取**：
   - "参考"xxx"" → 提取 `xxx`
   - "参考：xxx" → 提取 `xxx`
   - "见附件：xxx" → 提取 `xxx`

2. **文件查找**：
   - 在固定目录中查找：`{base_path}/videos/{filename}.mp4`
   - 支持多种扩展名：`.mp4`, `.avi`, `.mov`, `.pdf`, `.jpg`, `.png`

3. **创建 Asset**：
   - 如果找到文件，创建 `kb_asset` 记录
   - `asset_type`: 根据扩展名判断（video/image/pdf/other）
   - `url`: 文件访问 URL
   - `file_name`: 原始文件名

## RAG 检索时的处理

### 方案 A：Chunk 中包含文件引用

在生成 chunk 时，如果有关联的 asset，在 chunk_text 中追加：

```
【维修对策（解决办法）】
{原文}

【维修视频（附件）】
参考"下芯机比例阀拆解"
[附件链接: /uploads/videos/下芯机比例阀拆解.mp4]
```

### 方案 B：元数据关联

Chunk 中只保留文本，文件信息通过元数据关联：

- Chunk 包含：文本引用
- 前端展示：从 `kb_asset` 获取实际文件链接
- RAG 回答：可以提示"相关视频请查看附件"

## 实现优先级

### P0（当前）：文本引用
- ✅ 已完成：文本引用放在 `solution_text` 中

### P1（下一步）：文件匹配
- 从文本中提取文件名
- 在固定目录中查找文件
- 如果找到，创建 `kb_asset` 记录

### P2（未来）：智能匹配
- 支持模糊匹配（文件名相似度）
- 支持多个文件（一个知识条目多个附件）
- 支持文件上传和关联

## 配置建议

在 `.env` 中添加：

```env
# 附件文件基础路径
ATTACHMENT_BASE_PATH=/path/to/static
ATTACHMENT_BASE_URL=http://localhost:5000/uploads
```

## 总结

**当前阶段**：文本引用放在 `solution_text` 中 ✅

**未来优化**：
1. 文本引用保留（保证 RAG 检索）
2. 文件匹配并创建 `kb_asset`（提供文件访问）
3. 两者关联，但保持分离（最佳实践）

这样既保证了 RAG 的检索效果，又提供了文件访问能力。
