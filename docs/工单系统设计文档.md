# AI-Hub 售后工单系统设计文档

> **文档目的**：当 AI 智能客服无法解决用户问题时，需要生成工单并流转给人工工程师处理。本文档基于现有 AI-Hub 项目架构，设计一套与智能客服深度集成的工单系统方案，供评审与后续开发参考。

---

## 一、现状分析

### 1.1 现有能力

| 模块 | 技术栈 | 现状 |
|------|--------|------|
| **after-sales-ai** | Vue 3 + Vite | H5 智能客服前端，已有工单 UI（列表、详情、生成工单），数据存 localStorage，为演示版 |
| **ai-hub-service** | .NET 8 WebAPI | 知识库 CRUD、附件、用户认证、AI 审计日志，数据库 SQL Server (ai_hub) |
| **ai-hub-ai** | Python FastAPI | RAG 问答、意图识别（故障解决/转人工）、向量检索 |

### 1.2 工单触发场景

1. **用户主动**：在 AI 故障排查卡片上点击「生成工单」
2. **AI 建议**：意图识别为 `handoff`（转人工）时，引导用户生成工单或拨打客服
3. **AI 无法解决**：RAG 无匹配、置信度低、用户反馈「未解决」后选择转工单

### 1.3 当前工单数据模型（前端）

```typescript
// Ticket
ticketId, customerId, deviceId, sessionId, title, description,
status: '待处理'|'处理中'|'已解决'|'已关闭',
priority: '低'|'中'|'高'|'紧急',
assignee?, createdAt, closedAt?, finalSolutionSummary?

// TicketLog
logId, ticketId, action, content, operator, createdAt
```

### 1.4 缺口

- 工单无后端持久化，刷新即丢失
- 无真实流转（工程师接单、处理、关闭）
- 无与 AI 会话、消息、审计的关联
- 无多租户、权限、通知能力

---

## 二、设计目标

1. **与 AI 深度集成**：工单可关联 `ai_conversation`、`ai_message`、`ai_response`，一键带入问题上下文
2. **轻量流转**：支持待处理 → 处理中 → 已解决/已关闭，可扩展分派、转派
3. **复用现有能力**：用户认证、租户隔离、知识库、设备信息
4. **渐进式落地**：先实现核心 CRUD + 状态流转，再扩展通知、报表

---

## 三、系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户端 (after-sales-ai)                        │
│  聊天 → AI 回答 → [生成工单] → 工单列表/详情 → 查看处理进度            │
└───────────────────────────────┬─────────────────────────────────────┘
                               │ HTTP (JWT)
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    ai-hub-service (.NET 8)                            │
│  TicketsController: 工单 CRUD、状态流转、日志                         │
│  内部 API: 供 Python 服务创建工单（如 AI 自动建议转工单）              │
└───────────────────────────────┬─────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    SQL Server (ai_hub)                               │
│  ticket, ticket_log, ticket_attachment (新表)                         │
│  关联: ai_conversation, ai_message, kb_article, users                 │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 与现有服务的关系

- **ai-hub-service**：新增工单 API，作为工单数据的主服务
- **ai-hub-ai**：可选扩展，在 `handoff` 或低置信度时调用内部 API 预创建工单草稿
- **after-sales-ai**：将 localStorage 改为调用 ai-hub-service 工单 API

---

## 四、数据模型设计

### 4.1 工单主表 `ticket`

| 字段 | 类型 | 说明 |
|------|------|------|
| ticket_id | UNIQUEIDENTIFIER | 主键 |
| tenant_id | NVARCHAR(64) | 租户，与现有表一致 |
| ticket_no | NVARCHAR(32) | 工单号，如 T202602260001，便于人工沟通 |
| title | NVARCHAR(256) | 标题 |
| description | NVARCHAR(MAX) | 问题描述 |
| status | NVARCHAR(20) | 待处理/处理中/已解决/已关闭 |
| priority | NVARCHAR(10) | 低/中/高/紧急 |
| source | NVARCHAR(20) | 来源：ai_chat / manual / api |
| customer_id | NVARCHAR(64) | 客户 ID（可选，与业务客户表关联） |
| device_id | NVARCHAR(64) | 设备 ID（可选，与 YH_8082 设备表关联） |
| device_mn | NVARCHAR(64) | 设备 MN 号（可选） |
| session_id | UNIQUEIDENTIFIER | 关联 ai_conversation.conversation_id |
| trigger_message_id | UNIQUEIDENTIFIER | 触发工单的 ai_message.message_id |
| assignee_id | NVARCHAR(64) | 处理人 user_id |
| assignee_name | NVARCHAR(64) | 处理人姓名（冗余，便于展示） |
| created_by | NVARCHAR(64) | 创建人 user_id |
| created_at | DATETIME2 | 创建时间 |
| updated_at | DATETIME2 | 更新时间 |
| closed_at | DATETIME2 | 关闭时间 |
| final_solution_summary | NVARCHAR(MAX) | 最终解决方案摘要 |
| meta_json | NVARCHAR(MAX) | 扩展信息（AI 返回的 issue_category、alarm_code、cited_docs 等） |

### 4.2 工单日志表 `ticket_log`

| 字段 | 类型 | 说明 |
|------|------|------|
| log_id | BIGINT IDENTITY | 主键 |
| ticket_id | UNIQUEIDENTIFIER | 工单 ID |
| action | NVARCHAR(64) | 创建工单/开始处理/添加备注/解决/关闭/转派 |
| content | NVARCHAR(MAX) | 日志内容 |
| operator_id | NVARCHAR(64) | 操作人 |
| operator_name | NVARCHAR(64) | 操作人姓名 |
| next_status | NVARCHAR(20) | 变更后状态（可选） |
| created_at | DATETIME2 | 操作时间 |

### 4.3 工单附件表 `ticket_attachment`（可选，二期）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT IDENTITY | 主键 |
| ticket_id | UNIQUEIDENTIFIER | 工单 ID |
| file_name | NVARCHAR(256) | 文件名 |
| file_url | NVARCHAR(1000) | 访问地址 |
| file_type | NVARCHAR(50) | 类型 |
| created_at | DATETIME2 | 上传时间 |

---

## 五、工单流转设计

### 5.1 状态机

```
                    ┌─────────────┐
                    │   待处理    │
                    └──────┬──────┘
                           │ 开始处理
                           ▼
                    ┌─────────────┐
          ┌─────────│   处理中    │─────────┐
          │         └──────┬──────┘         │
          │ 关闭            │ 解决           │ 关闭
          ▼                 ▼                ▼
   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
   │   已关闭    │   │   已解决    │   │   已关闭    │
   └─────────────┘   └──────┬──────┘   └─────────────┘
                            │ 关闭
                            ▼
                     ┌─────────────┐
                     │   已关闭    │
                     └─────────────┘
```

### 5.2 流转规则

| 当前状态 | 可执行操作 | 目标状态 | 操作人 |
|----------|------------|----------|--------|
| 待处理 | 开始处理 | 处理中 | 工程师 |
| 待处理 | 关闭 | 已关闭 | 工程师/管理员 |
| 处理中 | 解决 | 已解决 | 工程师 |
| 处理中 | 关闭 | 已关闭 | 工程师 |
| 已解决 | 关闭 | 已关闭 | 工程师 |
| 已关闭 | - | - | 终态 |

### 5.3 角色与权限（建议）

| 角色 | 能力 |
|------|------|
| 客户/用户 | 创建工单、查看自己的工单、添加补充说明 |
| 工程师 | 接单、处理、解决、关闭、添加备注 |
| 管理员 | 全部操作、转派、查看统计 |

---

## 六、API 设计

### 6.1 工单 API（ai-hub-service）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/tickets | 创建工单 |
| GET | /api/tickets | 工单列表（分页、筛选、排序） |
| GET | /api/tickets/{id} | 工单详情 |
| PATCH | /api/tickets/{id} | 更新工单（状态、分配人、摘要等） |
| POST | /api/tickets/{id}/logs | 添加工单日志/备注 |
| GET | /api/tickets/{id}/logs | 工单日志列表 |
| POST | /api/tickets/{id}/start | 开始处理 |
| POST | /api/tickets/{id}/resolve | 标记已解决 |
| POST | /api/tickets/{id}/close | 关闭工单 |

### 6.2 创建工单请求体示例

```json
{
  "title": "工单：射砂异常 - E001",
  "description": "用户描述：设备不射砂，报警 E001",
  "sessionId": "uuid-of-ai-conversation",
  "triggerMessageId": "uuid-of-ai-message",
  "deviceId": "device-001",
  "deviceMn": "MN123456",
  "priority": "中",
  "meta": {
    "issueCategory": "射砂异常",
    "alarmCode": "E001",
    "citedDocs": [{"kbId": "1", "title": "E001 故障排查"}],
    "confidence": 0.75
  }
}
```

### 6.3 内部 API（供 ai-hub-ai 调用）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/ai/tickets | 内部创建工单（X-Internal-Token 鉴权） |

---

## 七、前端改造要点（after-sales-ai）

1. **移除 localStorage 工单存储**，改为调用 ai-hub-service `/api/tickets`
2. **生成工单时**：传入 `sessionId`、`triggerMessageId`、`deviceId`、AI 元数据（issueCategory、alarmCode 等）
3. **工单列表/详情**：从 API 拉取，支持刷新、分页
4. **工程师操作**：若 after-sales-ai 也供内部使用，可增加「开始处理」「解决」「关闭」按钮；或单独做工程师端（Web/App）

---

## 八、与 AI 的集成点

### 8.1 创建工单时带入的 AI 上下文

- `session_id` → 可反查完整对话
- `trigger_message_id` → 可反查用户问题、AI 回答、RAG 命中文档
- `meta_json` → 存储 issue_category、alarm_code、cited_docs、confidence，便于工程师快速了解 AI 判断

### 8.2 可选：AI 自动建议转工单

- 当 `intent=handoff` 或 `confidence < 0.5` 时，AI 服务可调用内部 API 创建工单草稿，并返回工单号给前端展示
- 或仅在前端展示「转人工」引导，由用户点击后再创建工单

---

## 九、实施阶段建议

### 阶段一：核心能力（MVP）

- [ ] 数据库：创建 `ticket`、`ticket_log` 表
- [ ] ai-hub-service：TicketsController，实现创建、列表、详情、状态流转
- [ ] after-sales-ai：对接 API，替换 localStorage

### 阶段二：增强

- [ ] 工单号生成规则（按租户、日期自增）
- [ ] 工程师端界面（或集成到现有管理后台）
- [ ] 权限控制（客户只看自己的，工程师看分配的）

### 阶段三：扩展

- [ ] 工单附件
- [ ] 转派、催办
- [ ] 消息/邮件通知
- [ ] 统计报表（响应时长、解决率等）

---

## 十、总结

本工单系统设计：

1. **复用现有架构**：以 ai-hub-service 为工单主服务，与 ai_conversation、ai_message 关联
2. **轻量流转**：四状态（待处理/处理中/已解决/已关闭），满足售后场景
3. **AI 深度集成**：工单携带会话、消息、AI 分析结果，便于工程师快速定位
4. **可渐进落地**：先 MVP 再扩展，降低初期投入

可将本文档提供给 ChatGPT 或其他 AI 助手进行评审、补充或生成具体实现代码。

---

*文档版本：v1.0 | 日期：2026-02-26*
